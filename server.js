const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');
const https = require('https');

const app = express();
const PORT = process.env.PORT || 3000;
const DEAL_AMOUNT_ADMIN = 9500; // Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
const DEAL_AMOUNT_TEAM = 2000; // Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ

// Telegram Bot Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (Ğ¶Ñ‘ÑÑ‚ĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
const TELEGRAM_BOT_TOKEN = '7840364464:AAEuBsIUKTnWxCnTaX0jn9WUMC5c4rp2nEk';
// Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°, ĞºÑƒĞ´Ğ° Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑĞ´ĞµĞ»Ğ¾Ğº)
const TELEGRAM_CHAT_ID = '-5240130674';
// Ğ‘Ğ¾Ñ‚ Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾ Ğ¿ĞµÑ€Ğ²ĞµĞ½ÑÑ‚Ğ²Ğµ
const NOTIFICATION_BOT_TOKEN = '8671998094:AAEyg-2G8cHIoTQT3gCjm1X5QiyW31D4WQo';
// ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ›Ğ¡ (Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ)
let ADMIN_USER_ID = null;

// ĞŸÑƒÑ‚ÑŒ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ (Ğ¾Ğ±ÑŠÑĞ²Ğ»ÑĞµĞ¼ ĞŸĞ•Ğ Ğ•Ğ” Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚)
const dataDir = path.join(__dirname, 'data');
const dealsFile = path.join(dataDir, 'deals.json');
const tasksFile = path.join(dataDir, 'tasks.json'); // Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹
const goalsFile = path.join(dataDir, 'goals.json'); // Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ñ†ĞµĞ»ĞµĞ¹
const usersFile = path.join(dataDir, 'users.json'); // Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹)
const adminIdFile = path.join(dataDir, 'adminId.json'); // Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ data ĞµÑĞ»Ğ¸ ĞµÑ‘ Ğ½ĞµÑ‚
function ensureDataDir() {
  if (!fs.existsSync(dataDir)) {
    fs.mkdirSync(dataDir, { recursive: true });
  }
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°
function loadAdminId() {
  ensureDataDir();
  if (!fs.existsSync(adminIdFile)) {
    return null;
  }
  try {
    const data = fs.readFileSync(adminIdFile, 'utf8');
    const adminData = JSON.parse(data);
    return adminData.userId || null;
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° adminId.json:', error);
    return null;
  }
}

// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ² Ñ„Ğ°Ğ¹Ğ»
function saveAdminId(userId) {
  ensureDataDir();
  try {
    fs.writeFileSync(adminIdFile, JSON.stringify({ userId: String(userId) }, null, 2), 'utf8');
    ADMIN_USER_ID = String(userId);
    console.log('âœ… ADMIN_USER_ID ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½:', ADMIN_USER_ID);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° adminId.json:', error);
  }
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ
ADMIN_USER_ID = loadAdminId();
if (ADMIN_USER_ID) {
  console.log('âœ… ADMIN_USER_ID Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°:', ADMIN_USER_ID);
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ´ĞµĞ»Ğ¾Ğº Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°
function loadDeals() {
  ensureDataDir();
  if (!fs.existsSync(dealsFile)) {
    return [];
  }
  try {
    const data = fs.readFileSync(dealsFile, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° deals.json:', error);
    return [];
  }
}

// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ´ĞµĞ»Ğ¾Ğº Ğ² Ñ„Ğ°Ğ¹Ğ»
function saveDeals(deals) {
  ensureDataDir();
  try {
    fs.writeFileSync(dealsFile, JSON.stringify(deals, null, 2), 'utf8');
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° deals.json:', error);
    throw error;
  }
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°
function loadTasks() {
  ensureDataDir();
  if (!fs.existsSync(tasksFile)) {
    return [];
  }
  try {
    const data = fs.readFileSync(tasksFile, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° tasks.json:', error);
    return [];
  }
}

// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹ Ğ² Ñ„Ğ°Ğ¹Ğ»
function saveTasks(tasks) {
  ensureDataDir();
  try {
    fs.writeFileSync(tasksFile, JSON.stringify(tasks, null, 2), 'utf8');
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° tasks.json:', error);
    throw error;
  }
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ†ĞµĞ»ĞµĞ¹ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°
function loadGoals() {
  ensureDataDir();
  if (!fs.existsSync(goalsFile)) {
    return [];
  }
  try {
    const data = fs.readFileSync(goalsFile, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° goals.json:', error);
    return [];
  }
}

// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ»ĞµĞ¹ Ğ² Ñ„Ğ°Ğ¹Ğ»
function saveGoals(goals) {
  ensureDataDir();
  try {
    fs.writeFileSync(goalsFile, JSON.stringify(goals, null, 2), 'utf8');
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° goals.json:', error);
    throw error;
  }
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°
function loadUsers() {
  ensureDataDir();
  if (!fs.existsSync(usersFile)) {
    return {};
  }
  try {
    const data = fs.readFileSync(usersFile, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° users.json:', error);
    return {};
  }
}

// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ² Ñ„Ğ°Ğ¹Ğ»
function saveUsers(users) {
  ensureDataDir();
  try {
    fs.writeFileSync(usersFile, JSON.stringify(users, null, 2), 'utf8');
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° users.json:', error);
    throw error;
  }
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ² Ğ›Ğ¡
async function sendNotificationToAdmin(text) {
  // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ADMIN_USER_ID Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ±Ñ‹Ğ» Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
  const currentAdminId = loadAdminId();
  if (currentAdminId) {
    ADMIN_USER_ID = currentAdminId;
  }
  
  if (!ADMIN_USER_ID) {
    console.log('âš ï¸ ADMIN_USER_ID Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½, ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾. Ğ¢ĞµĞºÑÑ‚:', text);
    console.log('ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ±Ñ‹Ğ» ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½');
    return false;
  }
  
  console.log('ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ² Ğ›Ğ¡ (userId:', ADMIN_USER_ID + '):', text.substring(0, 50) + '...');
  return await sendNotificationToUser(ADMIN_USER_ID, text);
}

async function sendNotificationToUser(userId, text) {
  if (!userId) {
    console.log('âš ï¸ userId Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½, ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾');
    return false;
  }
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
  if (!text || typeof text !== 'string' || text.trim().length === 0) {
    console.log('âš ï¸ Ğ¢ĞµĞºÑÑ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹, ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ´Ğ»Ñ userId:', userId);
    return false;
  }
  
  if (!NOTIFICATION_BOT_TOKEN) {
    console.error('âŒ NOTIFICATION_BOT_TOKEN Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½');
    return false;
  }
  
  const url = `https://api.telegram.org/bot${NOTIFICATION_BOT_TOKEN}/sendMessage`;
  const data = JSON.stringify({
    chat_id: String(userId),
    text: text.trim(),
    parse_mode: 'HTML'
  });

  console.log('ğŸ“¤ ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ', userId, 'Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ°', NOTIFICATION_BOT_TOKEN.substring(0, 10) + '...');

  return new Promise((resolve) => {
    const urlObj = new URL(url);
    const options = {
      hostname: urlObj.hostname,
      port: 443,
      path: urlObj.pathname + urlObj.search,
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(data, 'utf8')
      }
    };

    const req = https.request(options, (res) => {
      let responseData = '';
      res.on('data', (chunk) => {
        responseData += chunk;
      });
      res.on('end', () => {
        if (res.statusCode === 200) {
          try {
            const response = JSON.parse(responseData);
            if (response.ok) {
              console.log('âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ', userId);
              resolve(true);
            } else {
              console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ (Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ½Ğµ OK):', res.statusCode, responseData);
              // Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° 403 Ğ¸Ğ»Ğ¸ 400 - Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼
              if (response.error_code === 403 || response.error_code === 400) {
                console.error('ğŸ’¡ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼. ĞÑƒĞ¶Ğ½Ğ¾ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ñƒ /start');
              }
              resolve(false);
            }
          } catch (e) {
            console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°:', responseData);
            resolve(false);
          }
        } else {
          console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ (HTTP):', res.statusCode, responseData);
          try {
            const errorResponse = JSON.parse(responseData);
            if (errorResponse.error_code === 401) {
              console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° 401: ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ±Ğ¾Ñ‚ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚');
            } else if (errorResponse.error_code === 403) {
              console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° 403: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ» Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³');
              console.error('ğŸ’¡ Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ñƒ /start');
            }
          } catch (e) {}
          resolve(false);
        }
      });
    });

    req.on('error', (error) => {
      console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Telegram API:', error);
      resolve(false);
    });

    req.write(data);
    req.end();
  });
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Telegram (Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ message_id)
async function sendTelegramMessage(text) {
  const chatId = TELEGRAM_CHAT_ID;
  if (!chatId) {
    console.log('âš ï¸ TELEGRAM_CHAT_ID Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½, ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾');
    return null;
  }
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
  if (!text || typeof text !== 'string' || text.trim().length === 0) {
    console.log('âš ï¸ Ğ¢ĞµĞºÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹, ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾');
    return null;
  }

  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  const data = JSON.stringify({
    chat_id: String(chatId),
    text: text.trim(),
    parse_mode: 'HTML'
  });

  return new Promise((resolve) => {
    const urlObj = new URL(url);
    const options = {
      hostname: urlObj.hostname,
      port: 443,
      path: urlObj.pathname + urlObj.search,
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(data, 'utf8')
      }
    };

    const req = https.request(options, (res) => {
      let responseData = '';
      res.on('data', (chunk) => {
        responseData += chunk;
      });
      res.on('end', () => {
        if (res.statusCode === 200) {
          try {
            const response = JSON.parse(responseData);
            if (response.ok && response.result) {
              const messageId = response.result.message_id;
              console.log('âœ… Telegram ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾:', text.substring(0, 50) + '...', 'message_id:', messageId);
              resolve(messageId);
            } else {
              console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Telegram ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:', responseData);
              resolve(null);
            }
          } catch (e) {
            console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Telegram:', responseData);
            resolve(null);
          }
        } else {
          console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Telegram ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:', res.statusCode, responseData);
          resolve(null);
        }
      });
    });

    req.on('error', (error) => {
      console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Telegram API:', error);
      resolve(null);
    });

    req.write(data);
    req.end();
  });
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Telegram
async function deleteTelegramMessage(messageId) {
  const chatId = TELEGRAM_CHAT_ID;
  if (!chatId || !messageId) {
    return;
  }

  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/deleteMessage`;
  const data = JSON.stringify({
    chat_id: chatId,
    message_id: messageId
  });

  return new Promise((resolve, reject) => {
    const urlObj = new URL(url);
    const options = {
      hostname: urlObj.hostname,
      port: 443,
      path: urlObj.pathname + urlObj.search,
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': data.length
      }
    };

    const req = https.request(options, (res) => {
      let responseData = '';
      res.on('data', (chunk) => {
        responseData += chunk;
      });
      res.on('end', () => {
        if (res.statusCode === 200) {
          console.log('âœ… Telegram ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾, message_id:', messageId);
          resolve(true);
        } else {
          console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Telegram ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:', res.statusCode, responseData);
          resolve(false); // ĞĞµ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑĞµĞ¼, ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ
        }
      });
    });

    req.on('error', (error) => {
      console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Telegram API:', error);
      resolve(false); // ĞĞµ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑĞµĞ¼, ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ
    });

    req.write(data);
    req.end();
  });
}

app.use(cors());
app.use(express.json());

// Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
app.use((req, res, next) => {
  if (req.path.startsWith('/api/admin/')) {
    console.log('ğŸ“¥ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ:', req.method, req.path, 'Body:', JSON.stringify(req.body));
  }
  next();
});

function startOfDay(d) {
  const x = new Date(d);
  x.setHours(0, 0, 0, 0);
  return x.getTime();
}

function startOfMonth(d) {
  const x = new Date(d);
  x.setDate(1);
  x.setHours(0, 0, 0, 0);
  return x.getTime();
}

function calculateDeductions(amount) {
  const tax = Math.round(amount * 0.06); // 6% Ğ½Ğ°Ğ»Ğ¾Ğ³
  const leads = 500; // ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ»Ğ¸Ğ´Ğ°Ğ¼
  const employees = 2000; // Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ° ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°Ğ¼
  const totalDeductions = tax + leads + employees;
  const final = amount - totalDeductions;
  
  return {
    tax,
    leads,
    employees,
    totalDeductions,
    final
  };
}

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑÑƒĞ¼Ğ¼Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ñ Ğ²Ñ‹Ñ‡ĞµÑ‚Ğ°Ğ¼Ğ¸)
function getSumData() {
  try {
    const deals = loadDeals();

  const now = new Date();
  const todayStart = startOfDay(now);
  const monthStart = startOfMonth(now);

    let total = 0, monthSum = 0, daySum = 0;
    let totalTax = 0, monthTax = 0, dayTax = 0;
    let totalLeads = 0, monthLeads = 0, dayLeads = 0;
    let totalEmployees = 0, monthEmployees = 0, dayEmployees = 0;

  for (const d of deals) {
    // Ğ’ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ²ÑĞµ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ ĞºĞ°Ğº 9500â‚½
    const amt = DEAL_AMOUNT_ADMIN;
    const t = new Date(d.date).getTime();
      const deductions = calculateDeductions(amt);
      
    total += amt;
      totalTax += deductions.tax;
      totalLeads += deductions.leads;
      totalEmployees += deductions.employees;
      
      if (t >= monthStart) {
        monthSum += amt;
        monthTax += deductions.tax;
        monthLeads += deductions.leads;
        monthEmployees += deductions.employees;
      }
      
      if (t >= todayStart) {
        daySum += amt;
        dayTax += deductions.tax;
        dayLeads += deductions.leads;
        dayEmployees += deductions.employees;
      }
  }

  return {
    total,
    month: monthSum,
    day: daySum,
      totalTax,
      totalLeads,
      totalEmployees,
      totalFinal: total - totalTax - totalLeads - totalEmployees,
      monthTax,
      monthLeads,
      monthEmployees,
      monthFinal: monthSum - monthTax - monthLeads - monthEmployees,
      dayTax,
      dayLeads,
      dayEmployees,
      dayFinal: daySum - dayTax - dayLeads - dayEmployees
    };
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error);
    return {
      total: 0, month: 0, day: 0,
      totalTax: 0, totalLeads: 0, totalEmployees: 0, totalFinal: 0,
      monthTax: 0, monthLeads: 0, monthEmployees: 0, monthFinal: 0,
      dayTax: 0, dayLeads: 0, dayEmployees: 0, dayFinal: 0
    };
  }
}

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑÑƒĞ¼Ğ¼Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ğ±ĞµĞ· Ğ²Ñ‹Ñ‡ĞµÑ‚Ğ¾Ğ², Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑƒĞ¼Ğ¼Ğ¾Ğ¹)
function getTeamSumData(userId) {
  try {
    const deals = loadDeals();
    const now = new Date();
    const todayStart = startOfDay(now);
    const monthStart = startOfMonth(now);

    let totalAll = 0; // ĞĞ±Ñ‰Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº (admin + team, Ğ½Ğ¾ admin Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº 2000)
    let totalPersonal = 0; // ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ²ÑĞµ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹)
    let monthAll = 0, dayAll = 0;
    let monthPersonal = 0, dayPersonal = 0;

    for (const d of deals) {
      const t = new Date(d.date).getTime();
      let dealAmount = d.amount || (d.appType === 'admin' ? DEAL_AMOUNT_ADMIN : DEAL_AMOUNT_TEAM);
      
      // Ğ’ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğµ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ ĞºĞ°Ğº 2000
      if (d.appType === 'admin') {
        dealAmount = DEAL_AMOUNT_TEAM;
      }
      
      // ĞĞ±Ñ‰Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ ÑĞ´ĞµĞ»ĞºĞ¸)
      if (d.status === 'success') {
        totalAll += dealAmount;
        if (t >= monthStart) monthAll += dealAmount;
        if (t >= todayStart) dayAll += dealAmount;
      }
      
      // ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ²ÑĞµ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹)
      if (userId && d.userId && String(d.userId) === String(userId)) {
        totalPersonal += dealAmount;
        if (t >= monthStart) monthPersonal += dealAmount;
        if (t >= todayStart) dayPersonal += dealAmount;
      }
    }

    return {
      totalAll,
      monthAll,
      dayAll,
      totalPersonal,
      monthPersonal,
      dayPersonal
    };
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:', error);
    return {
      totalAll: 0, monthAll: 0, dayAll: 0,
      totalPersonal: 0, monthPersonal: 0, dayPersonal: 0
    };
  }
}

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ (Ğ¿Ğ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ğ¼ ÑĞ´ĞµĞ»ĞºĞ°Ğ¼ Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸ÑĞ¼)
function getLeaderboard() {
  try {
    const deals = loadDeals();
    const tasks = loadTasks();
    const userStats = {};
    
    // ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ ÑĞ´ĞµĞ»ĞºĞ¸
    for (const d of deals) {
      if (d.status === 'success' && d.userId) {
        const userId = String(d.userId);
        if (!userStats[userId]) {
          userStats[userId] = {
            userId: d.userId,
            username: d.createdBy || d.username || 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹',
            avatar: d.avatar || null,
            dealsCount: 0,
            tasksCount: 0,
            totalAmount: 0
          };
        }
        userStats[userId].dealsCount++;
        // Ğ”Ğ»Ñ Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ´ĞµĞ»ĞºĞ¸ ĞºĞ°Ğº 2000
        userStats[userId].totalAmount += DEAL_AMOUNT_TEAM;
      }
    }
    
    // ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ
    for (const task of tasks) {
      if (task.completedBy && Array.isArray(task.completedBy)) {
        for (const userId of task.completedBy) {
          const userIdStr = String(userId);
          if (!userStats[userIdStr]) {
            // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½ĞµÑ‚ Ğ² ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞµ, ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ
            userStats[userIdStr] = {
              userId: userId,
              username: 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ',
              avatar: null,
              dealsCount: 0,
              tasksCount: 0,
              totalAmount: 0
            };
          }
          userStats[userIdStr].tasksCount++;
        }
      }
    }
    
    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¸ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ ÑĞ´ĞµĞ»Ğ¾Ğº, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ¿Ğ¾ ÑÑƒĞ¼Ğ¼Ğµ
    const leaderboard = Object.values(userStats).sort((a, b) => {
      if (b.dealsCount !== a.dealsCount) {
        return b.dealsCount - a.dealsCount;
      }
      if (b.tasksCount !== a.tasksCount) {
        return b.tasksCount - a.tasksCount;
      }
      return b.totalAmount - a.totalAmount;
    });
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
    checkLeaderboardChanges(leaderboard);
    
    return leaderboard;
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹:', error);
    return [];
  }
}

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
let previousLeaderboard = [];
function checkLeaderboardChanges(currentLeaderboard) {
  try {
    if (previousLeaderboard.length > 0 && currentLeaderboard.length > 0) {
      const previousFirst = previousLeaderboard[0];
      const currentFirst = currentLeaderboard[0];
      
      // Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¼ĞµÑÑ‚Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ
      if (previousFirst && currentFirst && String(previousFirst.userId) !== String(currentFirst.userId)) {
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¼Ñƒ Ğ»Ğ¸Ğ´ĞµÑ€Ñƒ (Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
        const message = `âš ï¸ Ğ’Ñ‹ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ»Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ Ğ¼ĞµÑÑ‚Ğ¾ Ğ² Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ!\n\nĞ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ»Ğ¸Ğ´ĞµÑ€: ${currentFirst.username || 'Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ'}`;
        sendNotificationToUser(previousFirst.userId, message).catch(error => {
          console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ Ğ¿ĞµÑ€Ğ²ĞµĞ½ÑÑ‚Ğ²Ğ°:', error);
        });
      }
    }
    
    previousLeaderboard = JSON.parse(JSON.stringify(currentLeaderboard));
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ:', error);
  }
}

// Endpoint Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° (Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ)
app.post('/api/admin/set-id', (req, res) => {
  try {
    console.log('ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ ADMIN_USER_ID:', req.body);
    const { userId } = req.body;
    if (userId) {
      const userIdStr = String(userId);
      console.log('ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ADMIN_USER_ID:', userIdStr);
      
      // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
      saveAdminId(userIdStr);
      
      // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
      const loadedId = loadAdminId();
      console.log('âœ… ADMIN_USER_ID ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½:', ADMIN_USER_ID);
      console.log('âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°:', loadedId);
      
      // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
      sendNotificationToAdmin('âœ… Ğ’Ğ°Ñˆ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½! Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸ÑÑ….').then(function(sent) {
        if (sent) {
          console.log('âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾');
        } else {
          console.log('âš ï¸ Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ±Ğ¾Ñ‚ Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³)');
        }
      }).catch(function(err) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ:', err);
      });
      
      res.json({ ok: true, adminId: ADMIN_USER_ID, loadedFromFile: loadedId, message: 'ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½' });
    } else {
      console.log('âš ï¸ userId Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½ Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ');
      res.status(400).json({ error: 'userId is required' });
    }
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ADMIN_USER_ID:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ADMIN_USER_ID' });
  }
});

// Endpoint Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ADMIN_USER_ID
app.get('/api/admin/check-id', (req, res) => {
  try {
    // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ±Ñ‹Ğ» Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
    const loadedId = loadAdminId();
    if (loadedId) {
      ADMIN_USER_ID = loadedId;
    }
    res.json({ 
      ok: true, 
      adminId: ADMIN_USER_ID,
      isSet: !!ADMIN_USER_ID,
      fileExists: fs.existsSync(adminIdFile)
    });
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ADMIN_USER_ID:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ADMIN_USER_ID' });
  }
});

app.get('/api/sum', (req, res) => {
  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¸ ĞµÑ‰Ğµ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½)
  const adminId = req.query.adminId || req.headers['x-admin-id'];
  if (adminId && !ADMIN_USER_ID) {
    console.log('ğŸ’¾ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ADMIN_USER_ID Ñ‡ĞµÑ€ĞµĞ· /api/sum:', adminId);
    saveAdminId(adminId);
  }
  res.json(getSumData());
});

app.get('/api/deals', (req, res) => {
  try {
    const deals = loadDeals();
    // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ (Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²ĞµÑ€Ñ…Ñƒ)
    deals.sort((a, b) => new Date(b.date) - new Date(a.date));
    res.json(deals);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ´ĞµĞ»Ğ¾Ğº:', error);
    res.json([]);
  }
});

app.post('/api/deals', async (req, res) => {
  try {
    const username = String(req.body.username || '').trim().replace(/^@/, '') || 'user';
    const appType = req.body.appType || 'admin'; // 'admin' Ğ¸Ğ»Ğ¸ 'team'
    const userId = req.body.userId || null; // ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Telegram
    const userAvatar = req.body.avatar || null; // ĞĞ²Ğ°Ñ‚Ğ°Ñ€ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    const createdBy = req.body.createdBy || username; // Ğ˜Ğ¼Ñ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»Ñ
    
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2);
    const usernameFormatted = username.startsWith('@') ? username : '@' + username;
    
    const dealAmount = appType === 'admin' ? DEAL_AMOUNT_ADMIN : DEAL_AMOUNT_TEAM;
    
    const deals = loadDeals();
    const newDeal = {
      id,
      username: usernameFormatted,
      amount: dealAmount,
      date: new Date().toISOString(),
      status: 'pending',
      telegramMessageId: null,
      appType: appType,
      userId: userId,
      avatar: userAvatar,
      createdBy: createdBy
    };
    
    deals.push(newDeal);
    saveDeals(deals);

    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Telegram Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ message_id
    try {
      const messageId = await sendTelegramMessage(`Ğ¡Ğ´ĞµĞ»ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ»Ğ°ÑÑŒ ${usernameFormatted}`);
      if (messageId) {
        newDeal.telegramMessageId = messageId;
        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ´ĞµĞ»ĞºÑƒ Ñ message_id
        const dealIndex = deals.findIndex(d => d.id === id);
        if (dealIndex !== -1) {
          deals[dealIndex].telegramMessageId = messageId;
          saveDeals(deals);
        }
      }
    } catch (error) {
      console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Telegram ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ:', error);
    }

    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ
    deals.sort((a, b) => new Date(b.date) - new Date(a.date));
    res.json({ ok: true, deals });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ´ĞµĞ»ĞºĞ¸:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ´ĞµĞ»ĞºĞ¸' });
  }
});

app.patch('/api/deals/:id', async (req, res) => {
  try {
    const dealId = req.params.id;
    const { status, userId } = req.body; // userId Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ°Ğ²
    
    if (!status || !['pending', 'success', 'failed'].includes(status)) {
      return res.status(400).json({ error: 'Invalid status' });
    }

    const deals = loadDeals();
    const dealIndex = deals.findIndex(d => d.id === dealId);

    if (dealIndex === -1) {
      return res.status(404).json({ error: 'Deal not found' });
    }

    const deal = deals[dealIndex];
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ²: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑ‚ÑŒ ĞµÑ‘ (ĞºÑ€Ğ¾Ğ¼Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
    if (deal.appType === 'team' && userId && deal.userId && String(deal.userId) !== String(userId)) {
      return res.status(403).json({ error: 'You can only modify your own deals' });
    }
    
    const oldMessageId = deal.telegramMessageId;
    
    deals[dealIndex].status = status;
    saveDeals(deals);

    // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ
    try {
      if (status === 'success' || status === 'failed') {
        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸
        if (oldMessageId) {
          await deleteTelegramMessage(oldMessageId);
        }
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞµ
        const username = deal.username || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹';
        const messageText = status === 'success' 
          ? `Ğ¡Ğ´ĞµĞ»ĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ° ${username}` 
          : `Ğ¡Ğ´ĞµĞ»ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½Ğ° ${username}`;
        const newMessageId = await sendTelegramMessage(messageText);
        
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ message_id
        if (newMessageId) {
          deals[dealIndex].telegramMessageId = newMessageId;
          saveDeals(deals);
        }
      }
    } catch (error) {
      console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Telegram ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ:', error);
    }

    res.json({
      ok: true,
      deal: deals[dealIndex]
    });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ´ĞµĞ»ĞºĞ¸:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ´ĞµĞ»ĞºĞ¸' });
  }
});

app.delete('/api/deals/:id', async (req, res) => {
  try {
    const dealId = req.params.id;
    const { userId } = req.body; // userId Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ°Ğ²
    
    const deals = loadDeals();
    const dealIndex = deals.findIndex(d => d.id === dealId);

    if (dealIndex === -1) {
      return res.status(404).json({ error: 'Deal not found' });
    }

    const deal = deals[dealIndex];
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ²: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ ĞµÑ‘ (ĞºÑ€Ğ¾Ğ¼Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
    if (deal.appType === 'team' && userId && deal.userId && String(deal.userId) !== String(userId)) {
      return res.status(403).json({ error: 'You can only delete your own deals' });
    }
    
    const username = deal.username || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹';
    deals.splice(dealIndex, 1);
    saveDeals(deals);

    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Telegram
    try {
      await sendTelegramMessage(`Ğ¡Ğ´ĞµĞ»ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ° ${username}`);
    } catch (error) {
      console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Telegram ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ:', error);
    }

    res.json({ ok: true });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑĞ´ĞµĞ»ĞºĞ¸:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ ÑĞ´ĞµĞ»ĞºĞ¸' });
  }
});

// Endpoint Ğ´Ğ»Ñ Ğ¿Ğ¸Ğ½Ğ³Ğ° (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Render Ğ½Ğµ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°Ğ»)
app.get('/ping', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    message: 'Server is alive' 
  });
});

// ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ Ğ´Ğ»Ñ Ğ¿Ğ¸Ğ½Ğ³Ğ°
app.get('/api/ping', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    message: 'Server is alive' 
  });
});

// ========== ENDPOINTS Ğ”Ğ›Ğ¯ ĞšĞĞœĞĞĞ”ĞĞĞ“Ğ ĞŸĞ Ğ˜Ğ›ĞĞ–Ğ•ĞĞ˜Ğ¯ ==========

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑÑƒĞ¼Ğ¼Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
app.get('/api/team/sum', (req, res) => {
  try {
    const userId = req.query.userId || null;
    const data = getTeamSumData(userId);
    res.json(data);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑƒĞ¼Ğ¼Ñ‹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑƒĞ¼Ğ¼Ñ‹' });
  }
});

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ´ĞµĞ»Ğ¾Ğº Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹)
app.get('/api/team/deals', (req, res) => {
  try {
    const userId = req.query.userId || null;
    const filter = req.query.filter || 'all'; // 'all', 'personal'
    const deals = loadDeals();
    
    let filteredDeals = [];
    
    // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ
    if (filter === 'personal' && userId) {
      // Ğ›Ğ¸Ñ‡Ğ½Ñ‹Ğµ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ´ĞµĞ»ĞºĞ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ²ÑĞµ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹)
      filteredDeals = deals.filter(d => d.userId && String(d.userId) === String(userId));
    } else if (filter === 'all') {
      // ĞĞ±Ñ‰Ğ¸Ğµ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ ÑĞ´ĞµĞ»ĞºĞ¸ (status === 'success')
      filteredDeals = deals.filter(d => d.status === 'success');
    }
    
    // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ (Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²ĞµÑ€Ñ…Ñƒ)
    filteredDeals.sort((a, b) => new Date(b.date) - new Date(a.date));
    res.json(filteredDeals);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ´ĞµĞ»Ğ¾Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:', error);
    res.json([]);
  }
});

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
app.get('/api/leaderboard', (req, res) => {
  try {
    const leaderboard = getLeaderboard();
    res.json(leaderboard);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹:', error);
    res.json([]);
  }
});

// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹)
app.post('/api/users', (req, res) => {
  try {
    const { userId, username, avatar } = req.body;
    if (!userId) {
      return res.status(400).json({ error: 'userId is required' });
    }
    
    const users = loadUsers();
    users[String(userId)] = {
      userId: String(userId),
      username: username || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ',
      avatar: avatar || null,
      updatedAt: new Date().toISOString()
    };
    saveUsers(users);
    
    res.json({ ok: true });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ' });
  }
});

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ñ†ĞµĞ»Ğ¸
app.get('/api/goal', (req, res) => {
  try {
    const goals = loadGoals();
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ñ†ĞµĞ»ÑŒ (Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½ÑƒÑ)
    const currentGoal = goals.length > 0 ? goals[goals.length - 1] : null;
    res.json(currentGoal);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ»Ğ¸:', error);
    res.json(null);
  }
});

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ñ†ĞµĞ»Ğ¸ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ² Ğ»ÑĞ±Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ, Ğ½Ğ¾ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ†ĞµĞ»ÑŒ Ğ½Ğ° ÑÑ€Ğ¾Ğº Ğ½ĞµĞ´ĞµĞ»Ğ¸)
app.post('/api/goal', async (req, res) => {
  try {
    const { text, isAdmin } = req.body;
    
    if (!isAdmin) {
      return res.status(403).json({ error: 'Only admin can create goals' });
    }
    
    if (!text) {
      return res.status(400).json({ error: 'Goal text is required' });
    }
    
    const today = new Date();
    const goals = loadGoals();
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ»Ğ¸ ÑƒĞ¶Ğµ Ñ†ĞµĞ»ÑŒ Ğ½Ğ° ÑÑ‚Ñƒ Ğ½ĞµĞ´ĞµĞ»Ñ
    // ĞĞµĞ´ĞµĞ»Ñ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸ĞºĞ°
    const dayOfWeek = today.getDay(); // 0 = Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ, 1 = Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
    weekStart.setHours(0, 0, 0, 0);
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ñ†ĞµĞ»ÑŒ Ğ½Ğ° ÑÑ‚Ñƒ Ğ½ĞµĞ´ĞµĞ»Ñ
    const existingGoal = goals.find(g => {
      const goalDate = new Date(g.createdAt);
      const goalWeekStart = new Date(goalDate);
      const goalDayOfWeek = goalDate.getDay();
      goalWeekStart.setDate(goalDate.getDate() - (goalDayOfWeek === 0 ? 6 : goalDayOfWeek - 1));
      goalWeekStart.setHours(0, 0, 0, 0);
      
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ†ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ Ğº Ñ‚Ğ¾Ğ¹ Ğ¶Ğµ Ğ½ĞµĞ´ĞµĞ»Ğµ
      return goalWeekStart.getTime() === weekStart.getTime();
    });
    
    if (existingGoal) {
      return res.status(400).json({ error: 'Goal for this week already exists. You can create a new goal next week.' });
    }
    
    const newGoal = {
      id: Date.now().toString(36) + Math.random().toString(36).slice(2),
      text: text,
      createdAt: new Date().toISOString(),
      weekStart: weekStart.toISOString()
    };
    
    goals.push(newGoal);
    saveGoals(goals);
    
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼ Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ñ†ĞµĞ»Ğ¸
    try {
      const users = loadUsers();
      const message = `ğŸ¯ ĞĞ¾Ğ²Ğ°Ñ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ†ĞµĞ»ÑŒ!\n\n${text}`;
      
      for (const userId in users) {
        if (userId && userId !== 'undefined' && userId !== 'null') {
          await sendNotificationToUser(userId, message);
        }
      }
    } catch (error) {
      console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾ Ñ†ĞµĞ»Ğ¸:', error);
    }
    
    res.json({ ok: true, goal: newGoal });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ†ĞµĞ»Ğ¸:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ†ĞµĞ»Ğ¸' });
  }
});

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹ (Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ĞµĞ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ğµ)
app.get('/api/tasks', (req, res) => {
  try {
    const userId = req.query.userId || null;
    const tasks = loadTasks();
    
    // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼: Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ğ»
    // Ğ¸Ğ»Ğ¸ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¸Ğ¼ĞµÑÑ‚ pendingCompletions
    const filteredTasks = tasks.filter(task => {
      // Ğ•ÑĞ»Ğ¸ Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ĞµÑÑ‚ÑŒ userId, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾ Ğ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ
      if (userId) {
        const isConfirmed = task.completedBy && task.completedBy.includes(String(userId));
        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼
        return !isConfirmed;
      }
      // Ğ•ÑĞ»Ğ¸ userId Ğ½ĞµÑ‚, Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ
      return true;
    });
    
    // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ (Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²ĞµÑ€Ñ…Ñƒ)
    filteredTasks.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
    res.json(filteredTasks);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:', error);
    res.json([]);
  }
});

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹ (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ - Ñ pendingCompletions)
app.get('/api/admin/tasks', (req, res) => {
  try {
    const tasks = loadTasks();
    // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ (Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²ĞµÑ€Ñ…Ñƒ)
    tasks.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
    res.json(tasks);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹:', error);
    res.json([]);
  }
});

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½)
app.post('/api/tasks', async (req, res) => {
  try {
    const { title, description, reward, isAdmin } = req.body;
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ)
    // Ğ’ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ´ĞµÑÑŒ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· Telegram WebApp
    if (!isAdmin) {
      return res.status(403).json({ error: 'Only admin can create tasks' });
    }
    
    if (!title || !description || !reward) {
      return res.status(400).json({ error: 'Missing required fields' });
    }
    
    const tasks = loadTasks();
    const newTask = {
      id: Date.now().toString(36) + Math.random().toString(36).slice(2),
      title,
      description,
      reward: Number(reward) || 0,
      createdAt: new Date().toISOString(),
      completedBy: [], // ĞœĞ°ÑÑĞ¸Ğ² userId Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ¼
      pendingCompletions: [] // ĞœĞ°ÑÑĞ¸Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
    };
    
    tasks.push(newTask);
    saveTasks(tasks);
    
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼ Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¸
    try {
      const users = loadUsers();
      const message = `ğŸ“‹ ĞĞ¾Ğ²Ğ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ!\n\n${title}\n${description}\n\nĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: ${reward}â‚½`;
      
      // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼, Ñƒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… ĞµÑÑ‚ÑŒ userId
      for (const userId in users) {
        if (userId && userId !== 'undefined' && userId !== 'null') {
          await sendNotificationToUser(userId, message);
        }
      }
    } catch (error) {
      console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¸:', error);
    }
    
    res.json({ ok: true, task: newTask });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ' });
  }
});

// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ (Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ° Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ² pending)
app.patch('/api/tasks/:id', async (req, res) => {
  try {
    const taskId = req.params.id;
    const { userId, action, username, avatar } = req.body; // action: 'complete' Ğ¸Ğ»Ğ¸ 'uncomplete'
    
    if (!userId) {
      return res.status(400).json({ error: 'userId is required' });
    }
    
    const tasks = loadTasks();
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    
    if (taskIndex === -1) {
      return res.status(404).json({ error: 'Task not found' });
    }
    
    const task = tasks[taskIndex];
    
    if (action === 'complete') {
      // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ pendingCompletions ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
      if (!task.pendingCompletions) {
        task.pendingCompletions = [];
      }
      
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ
      const existing = task.pendingCompletions.find(p => String(p.userId) === String(userId));
      if (!existing) {
        task.pendingCompletions.push({
          userId: String(userId),
          username: username || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ',
          avatar: avatar || null,
          completedAt: new Date().toISOString() // Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ
        });
        
        // ĞœĞ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ² Ğ›Ğ¡ Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ
        try {
          const adminMessage = `ğŸ“‹ ĞĞ¾Ğ²Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ!\n\nĞ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ: ${task.title}\nĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: ${username || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ'}\nĞ’Ñ€ĞµĞ¼Ñ: ${new Date().toLocaleString('ru-RU')}`;
          await sendNotificationToAdmin(adminMessage);
        } catch (error) {
          console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ:', error);
        }
      }
    } else if (action === 'uncomplete') {
      // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· pending
      if (task.pendingCompletions) {
        task.pendingCompletions = task.pendingCompletions.filter(p => String(p.userId) !== String(userId));
      }
      // Ğ¢Ğ°ĞºĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ñ…, ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ»
      if (task.completedBy) {
        task.completedBy = task.completedBy.filter(id => String(id) !== String(userId));
      }
    }
    
    saveTasks(tasks);
    
    res.json({ ok: true, task: tasks[taskIndex] });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ' });
  }
});

// ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ¼
app.post('/api/tasks/:id/confirm', async (req, res) => {
  try {
    const taskId = req.params.id;
    const { userId, isAdmin } = req.body; // userId Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµĞ¼
    
    if (!isAdmin) {
      return res.status(403).json({ error: 'Only admin can confirm tasks' });
    }
    
    if (!userId) {
      return res.status(400).json({ error: 'userId is required' });
    }
    
    const tasks = loadTasks();
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    
    if (taskIndex === -1) {
      return res.status(404).json({ error: 'Task not found' });
    }
    
    const task = tasks[taskIndex];
    
    // Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ĞºĞ¾Ğ³Ğ¾-Ñ‚Ğ¾, Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑĞµĞ¼ Ğ²ÑĞµÑ… Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ…
    if (task.completedBy && task.completedBy.length > 0) {
      // Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ ÑƒĞ¶Ğµ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»Ñ, Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑĞµĞ¼ Ğ²ÑĞµÑ… Ğ¸Ğ· pending
      if (task.pendingCompletions) {
        const rejectedUsers = task.pendingCompletions.filter(p => String(p.userId) !== String(userId));
        task.pendingCompletions = [];
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼
        for (const rejected of rejectedUsers) {
          if (rejected && rejected.userId) {
            const message = `âŒ Ğ’Ğ°ÑˆĞµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ "${task.title}" Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¾. ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ ÑƒĞ¶Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½.`;
            await sendNotificationToUser(rejected.userId, message).catch(error => {
              console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:', error);
            });
          }
        }
      }
    } else {
      // ĞŸĞµÑ€Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ - Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑĞµĞ¼ Ğ²ÑĞµÑ… Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¸Ğ· pending
      if (task.pendingCompletions) {
        const rejectedUsers = task.pendingCompletions.filter(p => String(p.userId) !== String(userId));
        task.pendingCompletions = [];
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼
        for (const rejected of rejectedUsers) {
          if (rejected && rejected.userId) {
            const message = `âŒ Ğ’Ğ°ÑˆĞµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ "${task.title}" Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¾. ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ ÑƒĞ¶Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½.`;
            await sendNotificationToUser(rejected.userId, message).catch(error => {
              console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:', error);
            });
          }
        }
      }
    }
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ğµ
    if (!task.completedBy) {
      task.completedBy = [];
    }
    if (!task.completedBy.includes(String(userId))) {
      task.completedBy.push(String(userId));
    }
    
    saveTasks(tasks);
    
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    const confirmMessage = `âœ… Ğ’Ğ°ÑˆĞµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ "${task.title}" Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾! ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: ${task.reward}â‚½`;
    await sendNotificationToUser(userId, confirmMessage).catch(error => {
      console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:', error);
    });
    
    res.json({ ok: true, task: tasks[taskIndex] });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ' });
  }
});

// ĞÑ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ¼
app.post('/api/tasks/:id/reject', async (req, res) => {
  try {
    const taskId = req.params.id;
    const { userId, isAdmin } = req.body;
    
    if (!isAdmin) {
      return res.status(403).json({ error: 'Only admin can reject tasks' });
    }
    
    if (!userId) {
      return res.status(400).json({ error: 'userId is required' });
    }
    
    const tasks = loadTasks();
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    
    if (taskIndex === -1) {
      return res.status(404).json({ error: 'Task not found' });
    }
    
    const task = tasks[taskIndex];
    
    // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· pending
    if (task.pendingCompletions) {
      task.pendingCompletions = task.pendingCompletions.filter(p => String(p.userId) !== String(userId));
    }
    
    saveTasks(tasks);
    
    res.json({ ok: true, task: tasks[taskIndex] });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ' });
  }
});

// Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½)
app.delete('/api/tasks/:id', async (req, res) => {
  try {
    const taskId = req.params.id;
    const { isAdmin } = req.body;
    
    if (!isAdmin) {
      return res.status(403).json({ error: 'Only admin can delete tasks' });
    }
    
    const tasks = loadTasks();
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    
    if (taskIndex === -1) {
      return res.status(404).json({ error: 'Task not found' });
    }
    
    tasks.splice(taskIndex, 1);
    saveTasks(tasks);
    
    res.json({ ok: true });
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ' });
  }
});

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ ÑÑ€Ğ¾ĞºĞ° Ñ†ĞµĞ»Ğ¸ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
function checkGoalExpiration() {
  try {
    const goals = loadGoals();
    if (goals.length === 0) return;
    
    const currentGoal = goals[goals.length - 1];
    if (!currentGoal || !currentGoal.weekStart) return;
    
    const weekStart = new Date(currentGoal.weekStart);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 7); // ĞĞµĞ´ĞµĞ»Ñ = 7 Ğ´Ğ½ĞµĞ¹
    
    const now = new Date();
    
    // Ğ•ÑĞ»Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ñ Ğ¸ÑÑ‚ĞµĞºĞ»Ğ° Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ»Ğ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
    if (now >= weekEnd && !currentGoal.notificationSent) {
      // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ² Ğ›Ğ¡
      const adminMessage = `â° Ğ¡Ñ€Ğ¾Ğº ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ñ†ĞµĞ»Ğ¸ Ğ¸ÑÑ‚ĞµĞº!\n\nĞ¢ĞµĞºÑÑ‚ Ñ†ĞµĞ»Ğ¸: ${currentGoal.text}\n\nĞ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ñ†ĞµĞ»ÑŒ Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸.`;
      
      sendNotificationToAdmin(adminMessage).then(() => {
        // ĞÑ‚Ğ¼ĞµÑ‡Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾
        currentGoal.notificationSent = true;
        const goalIndex = goals.findIndex(g => g.id === currentGoal.id);
        if (goalIndex !== -1) {
          goals[goalIndex].notificationSent = true;
          saveGoals(goals);
        }
      }).catch(error => {
        console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ¾ Ñ†ĞµĞ»Ğ¸:', error);
      });
    }
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ»Ğ¸:', error);
  }
}

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ»Ğ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 30 Ğ¼Ğ¸Ğ½ÑƒÑ‚ (Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ĞµĞµ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ)
setInterval(checkGoalExpiration, 30 * 60 * 1000);
// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ
checkGoalExpiration();

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
app.listen(PORT, () => {
  console.log('âœ… Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!');
  console.log('GOLDEN TRAFF:', 'http://localhost:' + PORT);
  ensureDataDir();
  
  if (TELEGRAM_CHAT_ID) {
    console.log('âœ… Telegram Chat ID ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ (Ğ´Ğ»Ñ ÑĞ´ĞµĞ»Ğ¾Ğº Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ):', TELEGRAM_CHAT_ID);
  } else {
    console.log('âš ï¸ Telegram Chat ID Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ² ĞºĞ¾Ğ´Ğµ');
  }
  
  if (ADMIN_USER_ID) {
    console.log('âœ… ADMIN_USER_ID ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ (Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ² Ğ›Ğ¡):', ADMIN_USER_ID);
  } else {
    console.log('âš ï¸ ADMIN_USER_ID Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¾Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸.');
  }
  
  console.log('ğŸ“± Ğ‘Ğ¾Ñ‚ Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹:', NOTIFICATION_BOT_TOKEN ? 'Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½' : 'Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½');
});
